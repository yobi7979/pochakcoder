# SportsCoder DB 마이그레이션 가이드

## 📋 개요

이 문서는 SportsCoder 프로젝트에서 Stage DB에서 Main DB로 데이터를 마이그레이션하는 방법을 설명합니다.

## 🎯 마이그레이션 목적

- Stage DB의 모든 기본 설정 데이터를 Main DB로 이전
- 새로운 Main 프로젝트 배포 시 기본 데이터 준비
- 사용자 계정, 설정, 템플릿 등 모든 필수 데이터 보존

## 🔧 사전 준비

### 필요한 도구
- Node.js (v14 이상)
- PostgreSQL 클라이언트 (선택사항)
- Git

### 필요한 패키지
```bash
npm install pg
```

### 필요한 정보
- Stage DB 연결 문자열
- Main DB 연결 문자열

## 📊 Stage DB 정보

```
Stage DB URL: postgresql://postgres:REFuHuwHQbeBzRUuBuDopgLcdgIvocFo@trolley.proxy.rlwy.net:44142/railway
```

## 📊 Main DB 정보

```
Main DB URL: postgresql://postgres:tmSpMARWaYwSxNpjOrDsKseXyfqrsNrY@mainline.proxy.rlwy.net:41632/railway
```

## 🚀 마이그레이션 단계

### 1단계: 전체 데이터 마이그레이션

**파일**: `migrate-stage-to-main.js`

이 스크립트는 Stage DB의 모든 테이블과 데이터를 Main DB로 마이그레이션합니다.

```bash
node migrate-stage-to-main.js
```

**기능**:
- Stage DB의 모든 테이블 구조 조회
- 각 테이블의 데이터 백업
- Main DB에 테이블 생성 (존재하지 않는 경우)
- 데이터 삽입

**결과**:
- 대부분의 테이블이 성공적으로 마이그레이션됨
- 복잡한 구조의 테이블은 건너뜀 (templates, user_sessions, users)

### 2단계: 누락된 테이블 생성

**파일**: `create-missing-tables-fixed.js`

1단계에서 건너뛴 테이블들을 별도로 생성합니다.

```bash
node create-missing-tables-fixed.js
```

**생성되는 테이블**:
- `templates` (템플릿 데이터)
- `user_sessions` (사용자 세션)
- `users` (사용자 계정)

**특별 처리사항**:
- `USER-DEFINED` 타입을 `VARCHAR`로 변환
- `enum` 타입을 `VARCHAR`로 변환
- JSON 데이터 적절히 처리

### 3단계: 마이그레이션 확인

**파일**: `check-main-db-tables.js`

마이그레이션 결과를 확인합니다.

```bash
node check-main-db-tables.js
```

**확인 내용**:
- 모든 테이블 존재 여부
- 각 테이블의 레코드 수
- 누락된 테이블 식별

## 📋 마이그레이션된 테이블 목록

### 기본 데이터 테이블
- **MatchLists** (0개 레코드) - 경기 목록
- **MatchTeamLogos** (0개 레코드) - 경기별 팀 로고
- **Matches** (1개 레코드) - 경기 데이터
- **Settings** (28개 레코드) - 시스템 설정
- **SportActiveOverlayImages** (4개 레코드) - 활성 오버레이 이미지
- **SportOverlayImages** (2개 레코드) - 스포츠별 오버레이 이미지
- **Sports** (5개 레코드) - 스포츠 종목
- **TeamInfo** (2개 레코드) - 팀 정보
- **TeamLogos** (0개 레코드) - 팀 로고
- **UserSportPermissions** (1개 레코드) - 사용자 스포츠 권한

### 사용자 관련 테이블
- **templates** (2개 레코드) - 템플릿 데이터
- **user_sessions** (8개 레코드) - 사용자 세션
- **users** (2개 레코드) - 사용자 계정

## ⚠️ 주의사항

### 1. 데이터 타입 변환
- `USER-DEFINED` 타입 → `VARCHAR` 타입
- `enum` 타입 → `VARCHAR` 타입
- 시퀀스 참조 → `SERIAL` 타입

### 2. 예약어 처리
- `USER` → `"USER"` (따옴표로 감싸기)
- `CURRENT_USER` → `CURRENT_USER` (그대로 유지)

### 3. JSON 데이터 처리
- JSON 타입 필드는 문자열로 변환하여 삽입
- `JSON.stringify()` 사용

### 4. 충돌 방지
- `ON CONFLICT DO NOTHING` 사용
- 기존 데이터 보존

## 🔧 문제 해결

### 1. 연결 오류
```
Error: connect ECONNREFUSED
```
**해결방법**: 연결 문자열 확인 및 네트워크 상태 점검

### 2. 테이블 생성 오류
```
syntax error at or near "USER"
```
**해결방법**: 예약어를 따옴표로 감싸기

### 3. 데이터 타입 오류
```
invalid input syntax for type json
```
**해결방법**: JSON 데이터를 문자열로 변환

### 4. 시퀀스 오류
```
relation "table_id_seq" does not exist
```
**해결방법**: `SERIAL` 타입 사용

## 📁 생성되는 파일들

### 백업 파일
- `stage_backup_YYYY-MM-DDTHH-mm-ss-sssZ.json` - Stage DB 전체 백업

### 스크립트 파일
- `migrate-stage-to-main.js` - 전체 마이그레이션 스크립트
- `create-missing-tables-fixed.js` - 누락된 테이블 생성 스크립트
- `check-main-db-tables.js` - 마이그레이션 확인 스크립트

## 🎯 마이그레이션 완료 후 확인사항

### 1. 테이블 존재 확인
```sql
SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = 'public' 
AND table_type = 'BASE TABLE'
ORDER BY table_name;
```

### 2. 데이터 개수 확인
```sql
SELECT 
  schemaname,
  tablename,
  n_tup_ins as "inserts",
  n_tup_upd as "updates", 
  n_tup_del as "deletes",
  n_live_tup as "live_tuples",
  n_dead_tup as "dead_tuples"
FROM pg_stat_user_tables
ORDER BY tablename;
```

### 3. 애플리케이션 테스트
- 로그인 기능 테스트
- 기본 설정 로드 테스트
- 템플릿 로드 테스트

## 📝 마이그레이션 체크리스트

- [ ] Stage DB 연결 확인
- [ ] Main DB 연결 확인
- [ ] 전체 마이그레이션 실행
- [ ] 누락된 테이블 생성
- [ ] 마이그레이션 결과 확인
- [ ] 애플리케이션 테스트
- [ ] 백업 파일 보관

## 🔄 재마이그레이션 방법

필요시 다음 명령어로 재마이그레이션 가능:

```bash
# 1. 전체 마이그레이션
node migrate-stage-to-main.js

# 2. 누락된 테이블 생성
node create-missing-tables-fixed.js

# 3. 결과 확인
node check-main-db-tables.js
```

## 📞 지원

마이그레이션 과정에서 문제가 발생하면:
1. 오류 메시지 확인
2. 연결 문자열 검증
3. 네트워크 상태 점검
4. 데이터 타입 확인

---

**생성일**: 2025-10-29
**버전**: 1.0
**작성자**: SportsCoder 개발팀
