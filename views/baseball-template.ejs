<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baseball Overlay</title>
    <script>
        // 전역 변수 설정
        window.matchId = '<%= match.id %>';
        window.sportType = 'BASEBALL';
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        /* 기본 스타일 */
        body {
            margin: 0;
            padding: 0;
            font-family: 'Noto Sans KR', sans-serif;
            background-color: transparent;
            color: white;
            overflow: hidden;
        }

        .team-logo {
            max-width: 100%;
            max-height: 100%;
            background-color: rgba(255, 255, 255, 0.0);
            padding: 0px;
        }

                /* 실제 로고 영역: 원형 테두리 적용 */
        .team-logo-container {
            width: 40px;
            height: 40px;
            margin-right: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 5px;
        }

              /* 로고가 없을 때 표시될 플레이스홀더 스타일 */
        .team-logo-placeholder {
            width: 100%;                                 /* 부모 크기에 맞춤 */
            height: 100%;                                /* 부모 크기에 맞춤 */
            border-radius: 5px;                          /* 살짝 둥근 모서리 */
            background-color: rgba(0, 0, 0, 0.0);      /* 반투명 흰 배경 */
            display: flex;                               /* 텍스트 정렬용 flex */
            align-items: center;                         /* 세로 가운데 정렬 */
            justify-content: center;                     /* 가로 가운데 정렬 */
            font-weight: bold;                           /* 글씨 굵게 */
            color: white;                                /* 글씨 색 흰색 */
            font-size: 24px;                             /* 글씨 크기 24px */
        }


        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Noto Sans KR', Arial, sans-serif;
        }
        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
        }
        body {
            min-height: 100vh;
            min-width: 100vw;
            height: 100vh;
            width: 100vw;
            position: relative;
        }
        .overlay-container {
            width: 100vw;
            height: 100vh;
            min-width: 100vw;
            min-height: 100vh;
            position: relative;
        }

        /* 리스트 정보 표시 영역 */
        .list-info {
            position: absolute;
            top: 20px;
            right: 50px;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 1000;
            display: none;
        }
        
        .list-info.show {
            display: block;
        }
        
        .list-info .list-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .list-info .match-counter {
            font-size: 12px;
            opacity: 0.8;
        }
        
        /* 우측 하단 스코어보드 */
        .scoreboard {        
            position: fixed;
            bottom: 20px;
            right: 250px;
            width: 300px;
            height: 120px;
            background-color: rgb(208, 208, 208);
            display: flex;
            color: rgb(255, 255, 255);
            overflow: hidden;            
            border-top-left-radius: 10px;
            border-bottom-left-radius: 10px;
        }
        .team-section {
            display: flex;
            flex-direction: column;
            width: 100%;
        }
        .team-info {
            flex: 1;
            display: flex;
            align-items: center;
            padding: 5px 10px;
        }
        .team-info.home-team {
            background-color: rgb(57, 57, 57);
        }
        .team-info.away-team {
            background-color: rgb(57, 57, 57);
        }
        .team-header {
            width: 180px;
            font-size: 24px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: flex-start;            
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding-left: 10px;
        }
        .team-logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: flex;
            align-items: center;       /* 수직 가운데 정렬 */
            justify-content: center;   /* 수평 가운데 정렬 */
        }
        .team-logo.no-logo {
            font-size: 16px;
            color: rgba(255, 255, 255, 0.7);
        }
        .team-header.long {
            font-size: 18px;
        }
        .team-header.very-long {
            font-size: 16px;
        }
        .team-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 20px;
            min-width: 60px;
        }
        .team-score {
            font-size: 32px;
            font-weight: bold;
            min-width: 40px;
            text-align: right;
            padding-left: 15px; /* 오른쪽 여백을 줄이기 위해 패딩 추가 */
        }
        
        
        /* 베이스 상태 */
        .base-status {
            position: fixed;
            bottom: 20px;
            right: 130px;
            width: 120px;
            height: 120px;
            background-color: rgba(0, 0, 0, 0.98);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .inning-header {
            font-size: 18px;
            top: 50px;
            left: 70px;
            background-color: transparent;
        }
        .current-inning {
            margin-top: 60px;
            font-size: 28px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .inning-indicator {
            margin-left: 5px;
            font-size: 20px;
        }
        .inning-indicator.top:after {
            content: "▲";
            color: #3b82f6;
        }
        .inning-indicator.bottom:after {
            content: "▼";
            color: #3b82f6;
        }
        
        /* 게임 상태 (볼/스트라이크/아웃 카운트) */
        .game-status {
            position: fixed;
            bottom: 20px;
            right: 10px;
            width: 120px;
            height: 120px;
            background-color: rgba(0, 0, 0, 0.98);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px 0;
            border-top-right-radius: 10px;
            border-bottom-right-radius: 10px;
        }
        .base-container {
            width: 120px;
            height: 120px;
            position: relative;
            margin: 0 auto;
            background-color: transparent;
            transform: rotate(-45deg); /* 전체 45도 회전 */
        }
        .diamond {
            width: 80px;
            height: 80px;
            position: absolute; /* 요소를 절대 위치로 설정하여 부모 요소를 기준으로 위치를 조정합니다. */
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(45deg);
        }
        .base {
            width: 35px; /* 크기를 줄여서 간격을 좁힙니다. */
            height: 35px; /* 크기를 줄여서 간격을 좁힙니다. */
            position: absolute;
            background-color: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.4);
            transition: all 0.3s ease;
        }
        .base.active {
            background-color: #f59e0b;
            border-color: #d97706;
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.5);
        }
        .base.first {
            right: 15%;
            bottom: 50%;
            transform: translate(50%, 50%) rotate(45deg); /* 45도 회전 추가 */
        }
        .base.second {
            top: 15%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(45deg);
        }
        .base.third {
            left: 15%;
            bottom: 50%;
            transform: translate(-50%, 50%) rotate(45deg); /* 45도 회전 추가 */
        }
        
        .count-section {
            display: flex;
            flex-direction: column;
            gap: 5px;
            width: 100%;
            padding: 0 10px;
        }
        .count-row {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .count-label {
            font-size: 20px;
            width: 15px;
            text-align: left;
        }
        .count-indicators {
            display: flex;
            gap: 4px;
            flex: 1;
            justify-content: flex-start;
            margin-left: 0;
            padding-left: 0;
        }
        .count-dot {
            width: 23px;
            height: 23px;
            border-radius: 50%;
            background-color: #666;
            transition: background-color 0.3s ease;
        }
        .count-dot.ball.active {
            background-color: #22c55e;
        }
        .count-dot.strike.active {
            background-color: #eab308;
        }
        .count-dot.out.active {
            background-color: #ef4444;
        }
        
        /* 스트라이크와 아웃카운트 원들을 왼쪽으로 더 움직임 */
        .count-row:nth-child(1) .count-indicators,
        .count-row:nth-child(2) .count-indicators,
        .count-row:nth-child(3) .count-indicators {
            padding-left: -15px; /* 왼쪽으로 더 이동시키기 위해 패딩을 추가 */
        }
        
        /* 타자 정보 */
        .batter-info {
            position: absolute;
            left: 50px;
            top: 210px;
            width: 320px;
            height: 320px;
            background-color: rgba(0, 0, 0, 1.0);
            border-radius: 8px;
            color: white;
            overflow: hidden;
        }
        .panel-title {
            background-color: #ffffff;
            padding: 8px 12px;
            font-size: 16px;
            font-weight: bold;
        }
        .player-content {
            padding: 12px 15px;
            display: flex;
            align-items: center;
        }
        .player-number {
            width: 50px;
            height: 50px;
            background-color: rgba(0, 0, 0, 0.8);
            border-radius: 50%;
            font-size: 20px;
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 15px;
            align-self: flex-start; /* ← 부모 안에서 위로 붙이기 */
        }
        .player-info {
            flex: 1;
        }
        .player-name {
            font-size: 32px;
            font-weight: bold;
        }
        .player-position {
            font-size: 20px;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 3px;
        }
        .player-stats {
            margin-top: 10px;
            display: flex;
            gap: 15px;
            align-items: flex-start; /* ← 왼쪽 정렬 */
            flex-direction: column; /* ← 세로로 나열 */
            gap: 5px; /* 항목 간 간격 */
        }
        .stat-item {
            display: flex;
            flex-direction: row; /* ← 가로 정렬 */
            align-items: center;
            gap: 6px; /* 항목 간 간격 */
        }
        .stat-label {
            font-size: 20px;
            color: rgba(255, 255, 255, 0.6);
        }
        .stat-value {
            font-size: 20px;
            font-weight: bold;
            margin-top: 3px;
        }
        
        /* 투수 정보 */
        .pitcher-info {
            position: absolute;
            left: 420px;
            top: 210px;
            width: 320px;
            height: 320px;
            background-color: rgba(0, 0, 0, 1.0);
            border-radius: 8px;
            color: white;
            overflow: hidden;
        }
        .pitcher-info .panel-title {
            background-color: #ffffff;
        }
        .pitcher-info .player-number {
            background-color: rgba(0, 0, 0, 0.2);
        }
        
        /* 이닝 스코어 */
        .innings-scoreboard {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 800px;
            background-color: rgba(0, 0, 0, 1.0);
            border-radius: 8px;
            color: white;
            overflow: hidden;
        }
        .innings-title {
            background-color: rgb(0, 126, 52);
            padding: 8px 12px;
            font-size: 16px;
            font-weight: bold;
            text-align: center;
        }
        .innings-table {
            width: 100%;
            border-collapse: collapse;
        }
        .innings-table th, .innings-table td {
            padding: 8px;
            text-align: center;
            font-size: 14px;
        }
        .innings-table th {
            color: rgba(255, 255, 255, 0.7);
            background-color: rgba(255, 255, 255, 0.1);
        }
        .innings-table td {
            font-weight: bold;
        }
        .innings-table td.team-name {
            text-align: left;
            width: 120px;
        }
        .innings-table td.total {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        /* 오버레이 이미지 */
        .overlay-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 1920px;
            height: 1080px;
            z-index: 1000;
            display: none; /* 기본적으로 숨김 */
        }

        .overlay-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 0;
            box-shadow: none;
        }

        .overlay-image.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="overlay-container">
        <!-- 리스트 정보 표시 -->
        <% if (typeof listId !== 'undefined' && listId) { %>
        <div class="list-info" id="listInfo">
            <div class="list-name" id="listName"></div>
            <div class="match-counter" id="matchCounter"></div>
        </div>
        <% } %>
        
        <!-- 오버레이 이미지 -->
        <div class="overlay-image" id="overlayImage">
            <!-- 이미지는 JavaScript로 동적으로 로드됩니다 -->
        </div>
        
        <div class="scoreboard">
            <div class="team-section">
                <div class="team-info home-team" id="home-team-section">
                    <div class="team-logo-container">
                        <% if (match.match_data?.home_team_logo) { %>
                            <img src="<%= match.match_data.home_team_logo %>" alt="홈팀 로고" class="team-logo">
                        <% } else { %>
                            <div class="team-logo-placeholder"></div>
                        <% } %>
                    </div>
                    <div class="team-header"><%= match.home_team || 'HOME' %></div>
                    <div class="team-content">
                        <div class="team-score"><%= match.home_score || '0' %></div>
                    </div>
                </div>
                <div class="team-info away-team" id="away-team-section">
                    <div class="team-logo-container">
                        <% if (match.match_data?.away_team_logo) { %>
                            <img src="<%= match.match_data.away_team_logo %>" alt="원정팀 로고" class="team-logo">
                        <% } else { %>
                            <div class="team-logo-placeholder"></div>
                        <% } %>
                    </div>
                    <div class="team-header"><%= match.away_team || 'AWAY' %></div>
                    <div class="team-content">
                        <div class="team-score"><%= match.away_score || '0' %></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="inning-section">
            
        </div>

        <!-- 베이스 상태 섹션 -->
        <div class="base-status">
            <div class="base-container">
                <div class="diamond">
                    <div class="base first <%= match.match_data?.first_base ? 'active' : '' %>"></div>
                    <div class="base second <%= match.match_data?.second_base ? 'active' : '' %>"></div>
                    <div class="base third <%= match.match_data?.third_base ? 'active' : '' %>"></div>
                    <div class="inning-header"></div>
                    <div class="current-inning">
                    <%= match.match_data?.current_inning || '1' %>
                    <div class="inning-indicator <%= match.match_data?.inning_type === 'bottom' ? 'bottom' : 'top' %>"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 게임 상태 섹션 (볼/스트라이크/아웃 카운트) -->
        <div class="game-status">
            <div class="count-section">
                <div class="count-row">
                    <span class="count-label">B</span>
                    <div class="count-indicators">
                        <div class="count-dot ball <%= (match.match_data?.balls >= 1) ? 'active' : '' %>"></div>
                        <div class="count-dot ball <%= (match.match_data?.balls >= 2) ? 'active' : '' %>"></div>
                        <div class="count-dot ball <%= (match.match_data?.balls >= 3) ? 'active' : '' %>"></div>
                        <!-- <div class="count-dot ball <%= (match.match_data?.balls >= 4) ? 'active' : '' %>"></div> -->
                    </div>
                </div>
                <div class="count-row">
                    <span class="count-label">S</span>
                    <div class="count-indicators">
                        <div class="count-dot strike <%= (match.match_data?.strikes >= 1) ? 'active' : '' %>"></div>
                        <div class="count-dot strike <%= (match.match_data?.strikes >= 2) ? 'active' : '' %>"></div>
                        <!-- <div class="count-dot strike <%= (match.match_data?.strikes >= 3) ? 'active' : '' %>"></div> -->
                    </div>
                </div>
                <div class="count-row">
                    <span class="count-label">O</span>
                    <div class="count-indicators">
                        <div class="count-dot out <%= (match.match_data?.outs >= 1) ? 'active' : '' %>"></div>
                        <div class="count-dot out <%= (match.match_data?.outs >= 2) ? 'active' : '' %>"></div>
                        <div class="count-dot out <%= (match.match_data?.outs >= 3) ? 'active' : '' %>"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 타자 정보 -->
        <div class="batter-info">
            <div class="panel-title">현재 타자</div>
            <div class="player-content">
                <div class="player-number"><%= match.match_data?.batter_number || '25' %></div>
                <div class="player-info">
                    <div class="player-name batter-name"><%= match.match_data?.batter_name || '타자' %></div>
                    <div class="player-position"><%= match.match_data?.batter_position || '외야수' %></div>
                    <div class="player-stats">
                        <div class="stat-item">
                            <div class="stat-label">타율</div>
                            <div class="stat-value"><%= match.match_data?.batter_avg || '.342' %></div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">홈런</div>
                            <div class="stat-value"><%= match.match_data?.batter_hr || '15' %></div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">타점</div>
                            <div class="stat-value"><%= match.match_data?.batter_rbi || '52' %></div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">출루율</div>
                            <div class="stat-value"><%= match.match_data?.batter_obp || '.412' %></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 투수 정보 -->
        <div class="pitcher-info">
            <div class="panel-title">현재 투수</div>
            <div class="player-content">
                <div class="player-number"><%= match.match_data?.pitcher_number || '18' %></div>
                <div class="player-info">
                    <div class="player-name pitcher-name"><%= match.match_data?.pitcher_name || '투수' %></div>
                    <div class="player-position"><%= match.match_data?.pitcher_position || '우완 투수' %></div>
                    <div class="player-stats">
                        <div class="stat-item">
                            <div class="stat-label">평균자책점</div>
                            <div class="stat-value"><%= match.match_data?.pitcher_era || '2.48' %></div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">승패</div>
                            <div class="stat-value"><%= match.match_data?.pitcher_wl || '7-3' %></div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">투구 수</div>
                            <div class="stat-value"><%= match.match_data?.pitcher_pitches || '53' %></div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">탈삼진</div>
                            <div class="stat-value"><%= match.match_data?.pitcher_so || '5' %></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 이닝 스코어 -->
        <div class="innings-scoreboard">
            <div class="innings-title">이닝 스코어</div>
            <table class="innings-table">
                <thead>
                    <tr>
                        <th>팀</th>
                        <th>1</th>
                        <th>2</th>
                        <th>3</th>
                        <th>4</th>
                        <th>5</th>
                        <th>6</th>
                        <th>7</th>
                        <th>8</th>
                        <th>9</th>
                        <th>R</th>
                        <th>H</th>
                        <th>E</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="team-name"><%= match.home_team %></td>
                        <% for(let i = 1; i <= 9; i++) { %>
                            <td id="teamA-inning-<%= i %>"><%= match.match_data?.innings?.[`home_${i}`] || 0 %></td>
                        <% } %>
                        <td class="total"><%= match.home_score || 0 %></td>
                        <td class="total"><%= match.match_data?.home_hits || 0 %></td>
                        <td class="total"><%= match.match_data?.home_errors || 0 %></td>
                    </tr>
                    <tr>
                        <td class="team-name"><%= match.away_team %></td>
                        <% for(let i = 1; i <= 9; i++) { %>
                            <td id="teamB-inning-<%= i %>"><%= match.match_data?.innings?.[`away_${i}`] || 0 %></td>
                        <% } %>
                        <td class="total"><%= match.away_score || 0 %></td>
                        <td class="total"><%= match.match_data?.away_hits || 0 %></td>
                        <td class="total"><%= match.match_data?.away_errors || 0 %></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const socket = io();
        const matchId = '<%= match.id %>';
        
        // 경기 데이터 로드 함수
        async function loadMatchData() {
            try {
                const response = await fetch(`/api/matches/${matchId}`);
                const matchData = await response.json();
                window.matchData = matchData;  // 전역 변수로 저장
                console.log('🔧 경기 데이터 로드 완료:', matchData.sport_type);
                return matchData;
            } catch (error) {
                console.error('🔧 경기 데이터 로드 실패:', error);
                return null;
            }
        }

        // 소켓 연결
        socket.on('connect', async () => {
            console.log('=== Socket.IO 연결됨 (오버레이) ===');
            console.log('Socket ID:', socket.id);
            console.log('Match ID:', matchId);
            socket.emit('join', matchId);
            
            // 경기 데이터 로드 후 종목별 Room에 참여 요청
            const matchData = await loadMatchData();
            if (matchData) {
                // 서버에 종목별 Room 참여 요청
                socket.emit('join_sport_room', matchData.sport_type);
                console.log(`🔧 종목별 Room 참여 요청: sport_${matchData.sport_type}`);
            }
            
            // 종목별 Room 참여 확인 이벤트 리스너
            socket.on('joined_sport_room', (data) => {
                if (data.success) {
                    console.log(`🔧 야구 종목별 Room 참여 완료: ${data.roomName}`);
                    console.log(`🔧 Room 참여자 수: ${data.clientCount}`);
                    // Room 참여 완료 후 기존 활성 이미지 로드
                    loadOverlayImage();
                    
                    // 이벤트 리스너 재등록 (Room 참여 완료 후)
                    console.log('🔧 야구 이벤트 리스너 재등록 시작');
                    registerOverlayImageEventListeners();
                } else {
                    console.error(`🔧 야구 종목별 Room 참여 실패: ${data.error}`);
                }
            });
            
            if (typeof isListMode !== 'undefined' && isListMode && typeof listId !== 'undefined' && listId) { 
            // 리스트 오버레이 모드일 때 리스트 오버레이 방에도 참가
            socket.emit('join_list_overlay', '<%= listId %>');
            } 
        });
        
        socket.on('disconnect', () => {
            console.log('=== Socket.IO 연결 끊어짐 (오버레이) ===');
        });
        
        socket.on('connect_error', (error) => {
            console.error('=== Socket.IO 연결 오류 (오버레이) ===', error);
        });

                // match_update 이벤트 제거됨 - match_updated 이벤트로 통합

// 경기 수정 이벤트
        socket.on('match_updated', (data) => {
            if (data.matchId === matchId) {
                console.log('경기 수정 이벤트 수신:', data);
                
                // 팀명 업데이트
                const homeTeamElement = document.getElementById('home-team-name');
                const awayTeamElement = document.getElementById('away-team-name');
                
                if (homeTeamElement && data.home_team) {
                    homeTeamElement.textContent = data.home_team;
                    console.log('홈팀명 업데이트:', data.home_team);
                }
                if (awayTeamElement && data.away_team) {
                    awayTeamElement.textContent = data.away_team;
                    console.log('원정팀명 업데이트:', data.away_team);
                }
                
                // 종목 업데이트 (필요한 경우)
                if (data.sport_type && data.sport_type !== currentSportType) {
                    currentSportType = data.sport_type;
                    console.log('종목 변경됨:', currentSportType);
                }
                
                // 야구 특화 데이터 업데이트 (match_data가 있는 경우)
                if (data.match_data) {
                    console.log('🔥 야구 match_updated 이벤트 수신:', data.match_data);
                    console.log('🔥 이닝:', data.match_data.current_inning, '타입:', data.match_data.inning_type);
                    console.log('🔥 베이스 상태:', data.match_data.first_base, data.match_data.second_base, data.match_data.third_base);
                    console.log('🔥 볼카운트:', data.match_data.balls, '스트라이크:', data.match_data.strikes, '아웃:', data.match_data.outs);
                    
                    // 점수 업데이트 (이닝별 점수 합계로 계산)
                    let homeTotalScore = 0;
                    let awayTotalScore = 0;
                    
                    if (data.match_data?.innings) {
                        // 이닝별 점수 합계 계산
                        for (let i = 1; i <= 9; i++) {
                            homeTotalScore += parseInt(data.match_data.innings[`home_${i}`] || '0');
                            awayTotalScore += parseInt(data.match_data.innings[`away_${i}`] || '0');
                        }
                    } else {
                        // 이닝 데이터가 없으면 서버 점수 사용
                        homeTotalScore = data.home_score || 0;
                        awayTotalScore = data.away_score || 0;
                    }
                    
                    const homeScoreEl = document.querySelector('.home-team .team-score');
                    if (homeScoreEl) homeScoreEl.textContent = homeTotalScore;
                    const awayScoreEl = document.querySelector('.away-team .team-score');
                    if (awayScoreEl) awayScoreEl.textContent = awayTotalScore;
                } else {
                    // match_data가 없는 경우 서버 점수 사용
                    const homeScoreElement = document.querySelector('.home-team .team-score');
                    const awayScoreElement = document.querySelector('.away-team .team-score');
                    
                    if (homeScoreElement && data.home_score !== undefined) {
                        homeScoreElement.textContent = data.home_score;
                    }
                    if (awayScoreElement && data.away_score !== undefined) {
                        awayScoreElement.textContent = data.away_score;
                    }
                }
                
                // 야구 특화 데이터 업데이트 (match_data가 있는 경우에만)
                if (data.match_data) {
                    // 이닝 정보 업데이트
                    const inningElement = document.querySelector('.current-inning');
                    if (inningElement && data.match_data.current_inning) {
                        console.log('🔥 이닝 요소 찾음, 업데이트:', data.match_data.current_inning);
                        // 이닝 번호와 초/말 표시를 함께 업데이트
                        inningElement.innerHTML = `
                            ${data.match_data.current_inning}
                            <div class="inning-indicator ${data.match_data.inning_type === 'bottom' ? 'bottom' : 'top'}"></div>
                        `;
                        console.log('🔥 이닝 인디케이터 업데이트:', data.match_data.inning_type);
                    } else {
                        console.log('❌ 이닝 요소를 찾을 수 없음');
                    }
                    
                    // 베이스 상태 업데이트
                    if (data.match_data.first_base !== undefined) {
                        const firstBase = document.querySelector('.base.first');
                        if (firstBase) {
                            firstBase.classList.toggle('active', data.match_data.first_base);
                            console.log('🔥 1루 베이스 업데이트:', data.match_data.first_base);
                        }
                    }
                    if (data.match_data.second_base !== undefined) {
                        const secondBase = document.querySelector('.base.second');
                        if (secondBase) {
                            secondBase.classList.toggle('active', data.match_data.second_base);
                            console.log('🔥 2루 베이스 업데이트:', data.match_data.second_base);
                        }
                    }
                    if (data.match_data.third_base !== undefined) {
                        const thirdBase = document.querySelector('.base.third');
                        if (thirdBase) {
                            thirdBase.classList.toggle('active', data.match_data.third_base);
                            console.log('🔥 3루 베이스 업데이트:', data.match_data.third_base);
                        }
                    }
                    
                    // 볼/스트라이크/아웃 카운트 업데이트
                    if (data.match_data.balls !== undefined) {
                        const ballDots = document.querySelectorAll('.count-dot.ball');
                        console.log('🔥 볼 카운트 업데이트:', data.match_data.balls, '개 요소:', ballDots.length);
                        ballDots.forEach((el, index) => {
                            el.classList.toggle('active', index < data.match_data.balls);
                        });
                    }
                    if (data.match_data.strikes !== undefined) {
                        const strikeDots = document.querySelectorAll('.count-dot.strike');
                        console.log('🔥 스트라이크 카운트 업데이트:', data.match_data.strikes, '개 요소:', strikeDots.length);
                        strikeDots.forEach((el, index) => {
                            el.classList.toggle('active', index < data.match_data.strikes);
                        });
                    }
                    if (data.match_data.outs !== undefined) {
                        const outDots = document.querySelectorAll('.count-dot.out');
                        console.log('🔥 아웃 카운트 업데이트:', data.match_data.outs, '개 요소:', outDots.length);
                        outDots.forEach((el, index) => {
                            el.classList.toggle('active', index < data.match_data.outs);
                        });
                    }
                    
                    // 타자/투수 패널 제목 배경색 업데이트 (이닝 타입에 따라)
                    const isTopInning = data.match_data.inning_type !== 'bottom';
                    const batterTitlePanel = document.querySelector('.batter-info .panel-title');
                    const pitcherTitlePanel = document.querySelector('.pitcher-info .panel-title');
                    
                    if (batterTitlePanel && pitcherTitlePanel) {
                        // 팀 색상 가져오기
                        const homeTeamSection = document.getElementById('home-team-section');
                        const awayTeamSection = document.getElementById('away-team-section');
                        const homeTeamColor = homeTeamSection ? homeTeamSection.style.backgroundColor : null;
                        const awayTeamColor = awayTeamSection ? awayTeamSection.style.backgroundColor : null;
                        
                        // 팀 이름 가져오기
                        const homeTeamName = '<%= match.home_team %>';
                        const awayTeamName = '<%= match.away_team %>';
                        
                        // 이닝 타입에 따라 패널 제목 색상 설정
                        if (isTopInning) {
                            // 초(top) 이닝: 홈팀 타자, 어웨이팀 투수
                            if (homeTeamColor) batterTitlePanel.style.backgroundColor = homeTeamColor;
                            if (awayTeamColor) pitcherTitlePanel.style.backgroundColor = awayTeamColor;
                            batterTitlePanel.textContent = homeTeamName;  // 홈팀 타자
                            pitcherTitlePanel.textContent = awayTeamName; // 어웨이팀 투수
                            console.log('초 이닝: 홈팀 타자, 어웨이팀 투수');
                        } else {
                            // 말(bottom) 이닝: 어웨이팀 타자, 홈팀 투수
                            if (awayTeamColor) batterTitlePanel.style.backgroundColor = awayTeamColor;
                            if (homeTeamColor) pitcherTitlePanel.style.backgroundColor = homeTeamColor;
                            batterTitlePanel.textContent = awayTeamName;  // 어웨이팀 타자
                            pitcherTitlePanel.textContent = homeTeamName; // 홈팀 투수
                            console.log('말 이닝: 어웨이팀 타자, 홈팀 투수');
                        }
                    }
                    
                    // 선수 정보 업데이트
                    if (data.match_data.batter_name) {
                        const batterNameEl = document.querySelector('.batter-name');
                        if (batterNameEl) batterNameEl.textContent = data.match_data.batter_name;
                    }
                    if (data.match_data.batter_number) {
                        const batterNumberEl = document.querySelector('.batter-number');
                        if (batterNumberEl) batterNumberEl.textContent = data.match_data.batter_number;
                    }
                    if (data.match_data.pitcher_name) {
                        const pitcherNameEl = document.querySelector('.pitcher-name');
                        if (pitcherNameEl) pitcherNameEl.textContent = data.match_data.pitcher_name;
                    }
                    if (data.match_data.pitcher_number) {
                        const pitcherNumberEl = document.querySelector('.pitcher-number');
                        if (pitcherNumberEl) pitcherNumberEl.textContent = data.match_data.pitcher_number;
                    }
                    
                    // 팀 통계 업데이트
                    if (data.match_data.home_hits !== undefined) {
                        const homeHitsEl = document.querySelector('.home-hits');
                        if (homeHitsEl) homeHitsEl.textContent = data.match_data.home_hits;
                    }
                    if (data.match_data.away_hits !== undefined) {
                        const awayHitsEl = document.querySelector('.away-hits');
                        if (awayHitsEl) awayHitsEl.textContent = data.match_data.away_hits;
                    }
                    if (data.match_data.home_errors !== undefined) {
                        const homeErrorsEl = document.querySelector('.home-errors');
                        if (homeErrorsEl) homeErrorsEl.textContent = data.match_data.home_errors;
                    }
                    if (data.match_data.away_errors !== undefined) {
                        const awayErrorsEl = document.querySelector('.away-errors');
                        if (awayErrorsEl) awayErrorsEl.textContent = data.match_data.away_errors;
                    }
                    
                    // 이닝별 점수 업데이트
                    if (data.match_data.innings) {
                        for (let i = 1; i <= 9; i++) {
                            const homeInningEl = document.querySelector(`.home-inning-${i}`);
                            const awayInningEl = document.querySelector(`.away-inning-${i}`);
                            
                            if (homeInningEl && data.match_data.innings[`home_${i}`] !== undefined) {
                                homeInningEl.textContent = data.match_data.innings[`home_${i}`];
                            }
                            if (awayInningEl && data.match_data.innings[`away_${i}`] !== undefined) {
                                awayInningEl.textContent = data.match_data.innings[`away_${i}`];
                            }
                        }
                    }
                }
            }
        });

        // 실시간 타이머 업데이트 이벤트 처리 (야구는 이닝 정보)
        socket.on('timer_updated', (data) => {
            console.log('=== 야구 실시간 타이머 업데이트 수신 ===');
            console.log('타이머 업데이트 데이터:', data);
            
            if (data.matchId === matchId) {
                // 야구에서는 이닝 정보를 업데이트할 수 있음
                // 필요에 따라 이닝 관련 업데이트 로직 추가
                console.log('야구 타이머 업데이트:', data);
            }
        });


        // CSV 파일 처리 및 타율, 출루율 계산 함수
        function processPlayerCSV(csvData) {
            // CSV 파일 파싱 (탭으로 구분된 CSV)
            const lines = csvData.trim().split('\n');
            const headers = lines[0].split('\t').map(h => h.trim());
            const players = [];
            
            // 각 라인을 처리하여 선수 정보 추출
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue; // 빈 줄 건너뛰기
                
                const values = lines[i].split('\t').map(v => v.trim());
                const player = {};
                
                // 헤더에 따라 각 값 매핑
                headers.forEach((header, index) => {
                    player[header] = values[index] || '';
                });
                
                // 데이터 숫자 형식으로 변환
                const atBats = parseInt(player['타수'] || 0);
                const hits = parseInt(player['안타'] || 0);
                const homeRuns = parseInt(player['홈런'] || 0);
                const rbi = parseInt(player['타점'] || 0);
                const steals = parseInt(player['도루'] || 0);
                
                // 추가 통계 (CSV에는 없지만 계산에 필요)
                const walks = parseInt(player['볼넷'] || 0);  // 없으면 0으로 가정
                const hbp = parseInt(player['사구'] || 0);     // 없으면 0으로 가정
                const sf = parseInt(player['희생플라이'] || 0); // 없으면 0으로 가정
                
                // 타율 계산 (안타 / 타수)
                if (atBats > 0) {
                    player['타율'] = (hits / atBats).toFixed(3).substring(1);  // 앞의 0 제거, 소수점 3자리까지
                    if (!player['타율'].startsWith('.')) player['타율'] = '.' + player['타율'];  // 앞에 점 추가
                } else {
                    player['타율'] = '.000';
                }
                
                // 출루율 계산 (안타 + 볼넷 + 사구) / (타수 + 볼넷 + 사구 + 희생플라이)
                const onBaseNumerator = hits + walks + hbp;
                const onBaseDenominator = atBats + walks + hbp + sf;
                
                if (onBaseDenominator > 0) {
                    player['출루율'] = (onBaseNumerator / onBaseDenominator).toFixed(3).substring(1);
                    if (!player['출루율'].startsWith('.')) player['출루율'] = '.' + player['출루율'];
                } else {
                    player['출루율'] = '.000';
                }
                
                // 추가 값 확인
                if (!player['번호']) player['번호'] = i.toString();
                if (!player['이름']) player['이름'] = `선수${i}`;
                if (!player['포지션']) player['포지션'] = '미정';
                
                players.push(player);
            }
            
            return players;
        }
        
        // 선수 정보 업데이트 이벤트 처리
        socket.on('playerDataUpdated', function(data) {
            if (data.matchId === matchId) {
                console.log('선수 데이터 업데이트:', data);
                
                if (data.playerDataUrl) {
                    // JSON 파일에서 선수 데이터 가져오기
                    fetch(data.playerDataUrl)
                        .then(response => response.json())
                        .then(playerData => {
                            // 전역 변수에 선수 데이터 저장
                            window.playerData = playerData.players;
                            
                            console.log('선수 데이터 로드 완료:', playerData.players.length, '명');
                            
                            // 현재 타자/투수 정보 업데이트
                            if (data.batterIndex && playerData.players[data.batterIndex - 1]) {
                                const batter = playerData.players[data.batterIndex - 1];
                                updatePlayerInfo('.batter-info', batter);
                            }
                            
                            if (data.pitcherIndex && playerData.players[data.pitcherIndex - 1]) {
                                const pitcher = playerData.players[data.pitcherIndex - 1];
                                updatePlayerInfo('.pitcher-info', pitcher);
                            }
                        })
                        .catch(error => {
                            console.error('선수 데이터 불러오기 오류:', error);
                        });
                } else if (data.csvData) {
                    try {
                        // CSV 데이터 처리 (기존 방식 유지)
                        const players = processPlayerCSV(data.csvData);
                        
                        // 전역 변수에 선수 데이터 저장 (나중에 참조할 수 있도록)
                        window.playerData = players;
                        
                        console.log('선수 데이터 파싱 완료:', players.length, '명');
                        
                        // 현재 타자/투수 정보 업데이트
                        if (data.batterIndex && players[data.batterIndex - 1]) {
                            const batter = players[data.batterIndex - 1];
                            updatePlayerInfo('.batter-info', batter);
                        }
                        
                        if (data.pitcherIndex && players[data.pitcherIndex - 1]) {
                            const pitcher = players[data.pitcherIndex - 1];
                            updatePlayerInfo('.pitcher-info', pitcher);
                        }
                    } catch (error) {
                        console.error('선수 데이터 처리 중 오류 발생:', error);
                    }
                }
            }
        });
        
        // 선수 정보 패널 업데이트 함수
        function updatePlayerInfo(panelSelector, player) {
            const panel = document.querySelector(panelSelector);
            if (!panel) return;
            
            // 선수 번호 업데이트
            const numberElement = panel.querySelector('.player-number');
            if (numberElement) numberElement.textContent = player['번호'] || '';
            
            // 선수 이름 업데이트
            const nameElement = panel.querySelector('.player-name');
            if (nameElement) nameElement.textContent = player['이름'] || '';
            
            // 포지션 업데이트
            const positionElement = panel.querySelector('.player-position');
            if (positionElement) positionElement.textContent = player['포지션'] || '';
            
            // 타자 정보인 경우 통계 업데이트
            if (panelSelector === '.batter-info') {
                const stats = panel.querySelectorAll('.stat-item');
                if (stats.length >= 4) {
                    // 타율, 홈런, 타점, 출루율 업데이트
                    stats[0].querySelector('.stat-value').textContent = player['타율'] || '.000';
                    stats[1].querySelector('.stat-value').textContent = player['홈런'] || '0';
                    stats[2].querySelector('.stat-value').textContent = player['타점'] || '0';
                    stats[3].querySelector('.stat-value').textContent = player['출루율'] || '.000';
                }
            } 
            // 투수 정보인 경우 통계 업데이트
            else if (panelSelector === '.pitcher-info') {
                const stats = panel.querySelectorAll('.stat-item');
                if (stats.length >= 4) {
                    // 평균자책점, 승패, 투구 수, 탈삼진 업데이트
                    // 투수 관련 통계는 CSV에 없을 가능성이 높으므로 기본값 유지
                    if (player['평균자책점']) stats[0].querySelector('.stat-value').textContent = player['평균자책점'];
                    if (player['승패']) stats[1].querySelector('.stat-value').textContent = player['승패'];
                    if (player['투구수']) stats[2].querySelector('.stat-value').textContent = player['투구수'];
                    if (player['탈삼진']) stats[3].querySelector('.stat-value').textContent = player['탈삼진'];
                }
            }
        }

        // 현재 타자/투수 변경 이벤트 처리
        socket.on('currentPlayerChanged', function(data) {
            if (data.matchId === matchId) {
                console.log('현재 타자/투수 변경:', data);
                
                // 선수 데이터가 이미 로드되어 있는 경우 처리
                if (window.playerData) {
                    const players = window.playerData;
                    
                    // 타자 정보 업데이트
                    if (data.batterIndex && players[data.batterIndex - 1]) {
                        const batter = players[data.batterIndex - 1];
                        updatePlayerInfo('.batter-info', batter);
                    }
                    
                    // 투수 정보 업데이트
                    if (data.pitcherIndex && players[data.pitcherIndex - 1]) {
                        const pitcher = players[data.pitcherIndex - 1];
                        updatePlayerInfo('.pitcher-info', pitcher);
                    }
                }
            }
        });

        // 디자인 설정 로드 및 적용 함수
        async function loadDesignSettings() {
            try {
                const response = await fetch('/api/sport-overlay-design/BASEBALL');
                const result = await response.json();
                
                if (result.success) {
                    const design = result.design;
                    
                    // 스코어보드 위치 적용 (우측 하단 고정 위치로 설정)
                    const scoreboard = document.querySelector('.scoreboard');
                    if (scoreboard) {
                        scoreboard.style.position = 'fixed';
                        scoreboard.style.bottom = '20px';
                        scoreboard.style.right = '250px';
                        scoreboard.style.top = 'auto';
                        scoreboard.style.left = 'auto';
                    }
                    
                    // 홈팀 로고 위치 적용 (야구는 team-info.home-team 사용)
                    const homeLogo = document.querySelector('.team-info.home-team');
                    if (homeLogo && design.homeLogo) {
                        homeLogo.style.top = `${design.homeLogo.top}px`;
                        if (design.homeLogo.left !== undefined) {
                            homeLogo.style.left = `${design.homeLogo.left}px`;
                        }
                        if (design.homeLogo.right !== undefined) {
                            homeLogo.style.right = `${design.homeLogo.right}px`;
                        }
                    }
                    
                    // 어웨이팀 로고 위치 적용 (야구는 team-info.away-team 사용)
                    const awayLogo = document.querySelector('.team-info.away-team');
                    if (awayLogo && design.awayLogo) {
                        awayLogo.style.top = `${design.awayLogo.top}px`;
                        if (design.awayLogo.left !== undefined) {
                            awayLogo.style.left = `${design.awayLogo.left}px`;
                        }
                        if (design.awayLogo.right !== undefined) {
                            awayLogo.style.right = `${design.awayLogo.right}px`;
                        }
                    }
                    
                    // 경기 상태 위치 적용
                    const matchState = document.querySelector('.current-inning');
                    if (matchState && design.matchState) {
                        matchState.style.top = `${design.matchState.top}px`;
                        if (design.matchState.left !== undefined) {
                            matchState.style.left = `${design.matchState.left}px`;
                        }
                        if (design.matchState.right !== undefined) {
                            matchState.style.right = `${design.matchState.right}px`;
                        }
                    }
                    
                    // 홈팀 라인업 위치 적용
                    const homeLineup = document.querySelector('.batter-info');
                    if (homeLineup && design.homeLineup) {
                        homeLineup.style.top = `${design.homeLineup.top}px`;
                        if (design.homeLineup.left !== undefined) {
                            homeLineup.style.left = `${design.homeLineup.left}px`;
                        }
                        if (design.homeLineup.right !== undefined) {
                            homeLineup.style.right = `${design.homeLineup.right}px`;
                        }
                    }
                    
                    // 어웨이팀 라인업 위치 적용
                    const awayLineup = document.querySelector('.pitcher-info');
                    if (awayLineup && design.awayLineup) {
                        awayLineup.style.top = `${design.awayLineup.top}px`;
                        if (design.awayLineup.left !== undefined) {
                            awayLineup.style.left = `${design.awayLineup.left}px`;
                        }
                        if (design.awayLineup.right !== undefined) {
                            awayLineup.style.right = `${design.awayLineup.right}px`;
                        }
                    }
                    
                    // 오버레이 이미지 위치 적용
                    const overlayImage = document.getElementById('overlayImage');
                    if (overlayImage && design.overlayImage) {
                        overlayImage.style.top = `${design.overlayImage.top}px`;
                        if (design.overlayImage.left !== undefined) {
                            overlayImage.style.left = `${design.overlayImage.left}px`;
                        }
                        if (design.overlayImage.width !== undefined) {
                            overlayImage.style.width = `${design.overlayImage.width}px`;
                        }
                        if (design.overlayImage.height !== undefined) {
                            overlayImage.style.height = `${design.overlayImage.height}px`;
                        }
                    }
                    
                    // 타이머 위치 적용
                    const timer = document.querySelector('.match-time');
                    if (timer && design.timer) {
                        if (design.timer.marginLeft !== undefined) {
                            timer.style.marginLeft = `${design.timer.marginLeft}px`;
                        }
                    }
                    
                    console.log('야구 디자인 설정 적용 완료');
                }
            } catch (error) {
                console.error('야구 디자인 설정 로드 오류:', error);
            }
        }

        // 오버레이 이미지 로드 함수 (활성화된 모든 이미지 표시)
    // 한글 파일명 디코딩 함수 (브라우저 호환 버전)
    function decodeKoreanFilename(filename) {
        try {
            // 깨진 파일명인지 확인
            if (filename.includes('ì') || filename.includes('ë') || filename.includes('í') || 
                filename.includes('â') || filename.includes('ê') || filename.includes('ô')) {
                
                // 브라우저 환경에서 한글 파일명 디코딩
                let decoded = filename;
                try {
                    // URL 디코딩 시도
                    decoded = decodeURIComponent(filename);
                } catch (e) {
                    // URL 디코딩 실패 시 원본 반환
                    console.log(`🔧 URL 디코딩 실패, 원본 사용: ${filename}`);
                    return filename;
                }
                
                console.log(`🔧 클라이언트 파일명 디코딩: ${filename} -> ${decoded}`);
                return decoded;
            }
            return filename;
        } catch (error) {
            console.error('🔧 클라이언트 파일명 디코딩 실패:', error);
            return filename;
        }
    }

    // 오버레이 이미지 이벤트 리스너 재등록 함수 (야구용)
    function registerOverlayImageEventListeners() {
        console.log('🔧 야구 오버레이 이미지 이벤트 리스너 재등록');
        
        // 기존 이벤트 리스너 제거 (중복 방지)
        socket.off('overlay_image_status_changed');
        socket.off('overlay_page_refresh');
        
        // 오버레이 이미지 상태 변경 실시간 이벤트 처리 (재등록)
        socket.on('overlay_image_status_changed', function(data) {
            console.log('🔧 야구 오버레이 이미지 상태 변경 실시간 이벤트 (재등록):', data);
            console.log('🔧 현재 window.matchData:', window.matchData);
            console.log('🔧 현재 경기 sport_type:', window.matchData?.sport_type);
            console.log('🔧 이벤트 sportCode:', data.sportCode);
            
            // 현재 경기의 스포츠 타입과 동적 비교 (window.matchData 사용)
            if (data.sportCode === window.matchData?.sport_type) {
                console.log('🔧 야구 스포츠 타입 일치, 이미지 처리 시작 (재등록)');
                
                if (data.isActive && data.imageData) {
                    // 이미지 활성화 - 해당 이미지만 추가 표시
                    console.log('🔧 야구 오버레이 이미지 활성화 (재등록):', data.imageData);
                    addOverlayImage(data.imageData);
                } else if (!data.isActive && data.imageData) {
                    // 이미지 비활성화 - 해당 이미지만 제거
                    console.log('🔧 야구 오버레이 이미지 비활성화 (재등록):', data.imageData);
                    removeOverlayImage(data.imageData.id);
                }
            } else {
                console.log('🔧 야구 스포츠 타입 불일치, Room 재참여 시도 (재등록)');
                // 스포츠 타입이 일치하지 않으면 Room 재참여 시도
                if (window.matchData?.sport_type) {
                    console.log('🔧 야구 Room 재참여 요청 (재등록):', window.matchData.sport_type);
                    socket.emit('join_sport_room', window.matchData.sport_type);
                }
            }
        });

        // 오버레이 페이지 새로고침 이벤트 처리 (재등록)
        socket.on('overlay_page_refresh', function(data) {
            console.log('🔧 야구 오버레이 페이지 새로고침 신호 수신 (재등록):', data);
            console.log('🔧 현재 window.matchData:', window.matchData);
            console.log('🔧 현재 경기 sport_type:', window.matchData?.sport_type);
            console.log('🔧 이벤트 sportCode:', data.sportCode);
            
            // 현재 경기의 스포츠 타입과 동적 비교
            if (data.sportCode === window.matchData?.sport_type) {
                console.log('🔧 야구 오버레이 페이지 새로고침 실행 (재등록):', data.reason);
                // 페이지 새로고침
                location.reload();
            } else {
                console.log('🔧 야구 스포츠 타입 불일치로 새로고침 건너뜀 (재등록)');
                // 대안: window.matchData가 없을 때도 새로고침 (디버깅용)
                if (!window.matchData) {
                    console.log('🔧 야구 window.matchData가 없어서 강제 새로고침 실행 (재등록)');
                    location.reload();
                }
            }
        });
        
        console.log('🔧 야구 오버레이 이미지 이벤트 리스너 재등록 완료');
    }

    // 오버레이 이미지 추가 함수 (다중 이미지 지원) - 야구용
    function addOverlayImage(imageData) {
        const overlayImageContainer = document.getElementById('overlayImage');
        if (!overlayImageContainer) return;
        
        console.log('🔧 야구 오버레이 이미지 추가:', imageData);
        
        // 이미 존재하는 이미지인지 확인
        const existingImg = overlayImageContainer.querySelector(`[data-image-id="${imageData.id}"]`);
        if (existingImg) {
            console.log('🔧 야구 이미지가 이미 존재함:', imageData.id);
            return;
        }
        
        const img = document.createElement('img');
        img.setAttribute('data-image-id', imageData.id);
        
        // 파일 경로에서 파일명 추출 및 디코딩
        const pathParts = imageData.file_path.split('/');
        const filename = pathParts[pathParts.length - 1];
        const decodedFilename = decodeKoreanFilename(filename);
        const decodedPath = imageData.file_path.replace(filename, decodedFilename);
        
        img.src = decodedPath;
        img.alt = '오버레이 이미지';
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'cover';
        img.style.position = 'absolute';
        img.style.top = '0';
        img.style.left = '0';
        img.style.zIndex = '1';
        
        img.onload = () => {
            overlayImageContainer.appendChild(img);
            overlayImageContainer.classList.add('show');
            console.log('🔧 야구 오버레이 이미지 추가 완료:', imageData.id);
        };
        
        img.onerror = (error) => {
            console.error('🔧 야구 오버레이 이미지 로드 실패:', error);
        };
    }
    
    // 오버레이 이미지 제거 함수 (다중 이미지 지원) - 야구용
    function removeOverlayImage(imageId) {
        const overlayImageContainer = document.getElementById('overlayImage');
        if (!overlayImageContainer) return;
        
        console.log('🔧 야구 오버레이 이미지 제거:', imageId);
        
        const imgToRemove = overlayImageContainer.querySelector(`[data-image-id="${imageId}"]`);
        if (imgToRemove) {
            imgToRemove.remove();
            console.log('🔧 야구 오버레이 이미지 제거 완료:', imageId);
            
            // 모든 이미지가 제거되었으면 컨테이너 숨김
            const remainingImages = overlayImageContainer.querySelectorAll('img');
            if (remainingImages.length === 0) {
                overlayImageContainer.classList.remove('show');
            }
        }
    }
    
    // 오버레이 이미지 표시 함수 (실시간 업데이트용) - 야구용
    function displayOverlayImage(imageData) {
        const overlayImageContainer = document.getElementById('overlayImage');
        if (!overlayImageContainer) return;
        
        console.log('🔧 야구 오버레이 이미지 표시:', imageData);
        
        // 기존 이미지 제거
        overlayImageContainer.innerHTML = '';
        
        const img = document.createElement('img');
        // 파일 경로에서 파일명 추출 및 디코딩
        const pathParts = imageData.file_path.split('/');
        const filename = pathParts[pathParts.length - 1];
        const decodedFilename = decodeKoreanFilename(filename);
        const decodedPath = imageData.file_path.replace(filename, decodedFilename);
        
        img.src = decodedPath;
        img.alt = '오버레이 이미지';
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'cover';
        img.style.position = 'absolute';
        img.style.top = '0';
        img.style.left = '0';
        img.style.zIndex = '1';
        
        img.onload = () => {
            overlayImageContainer.appendChild(img);
            overlayImageContainer.classList.add('show');
            console.log('🔧 야구 오버레이 이미지 로드 완료');
        };
        
        img.onerror = (error) => {
            console.error('🔧 야구 오버레이 이미지 로드 실패:', error);
            overlayImageContainer.classList.remove('show');
        };
    }
    
    // 오버레이 이미지 숨김 함수 (실시간 업데이트용) - 야구용
    function hideOverlayImage() {
        const overlayImageContainer = document.getElementById('overlayImage');
        if (!overlayImageContainer) return;
        
        console.log('🔧 야구 오버레이 이미지 숨김');
        overlayImageContainer.classList.remove('show');
        overlayImageContainer.innerHTML = '';
    }

    async function loadOverlayImage() {
        try {
            console.log('야구 오버레이 이미지 로드 시작...');
                
                // 경기 정보에서 종목 코드 가져오기
                const matchResponse = await fetch(`/api/matches/${matchId}`);
                if (!matchResponse.ok) {
                    console.error('경기 정보를 가져올 수 없습니다.');
                    return;
                }
                
                const matchData = await matchResponse.json();
                const sportCode = matchData.sport_type.toUpperCase();
                console.log('종목 코드:', sportCode);
                
                // 종목코드 그대로 사용 (종목명 대신)
                const sportCodeForPath = sportCode;
                console.log('종목코드:', sportCodeForPath);
                
                // 해당 종목의 활성화된 이미지 조회
                const response = await fetch(`/api/overlay-images/active/${sportCode}`);
                const result = await response.json();
                
                console.log('야구 활성화된 이미지 목록 조회 결과:', result);
                
                const overlayImageContainer = document.getElementById('overlayImage');
                
                if (result.success && result.images && result.images.length > 0) {
                    console.log('🔧 야구 활성화된 이미지들:', result.images);
                    
                    // 모든 활성화된 이미지를 표시
                    overlayImageContainer.innerHTML = '';
                    
                    result.images.forEach((image, index) => {
                        const img = document.createElement('img');
                        img.setAttribute('data-image-id', image.id);
                        
                        // 종목코드 기반 경로로 직접 구성
                        const filename = image.filename;
                        const decodedFilename = decodeKoreanFilename(filename);
                        const imagePath = `/overlay-images/${sportCodeForPath}/${decodedFilename}`;
                        
                        console.log(`🔧 야구 이미지 경로 구성: ${imagePath}`);
                        img.src = imagePath;
                        img.alt = `야구 오버레이 이미지 ${index + 1}`;
                        img.style.width = '100%';
                        img.style.height = '100%';
                        img.style.objectFit = 'cover';
                        img.style.position = 'absolute';
                        img.style.top = '0';
                        img.style.left = '0';
                        img.style.zIndex = 1000 + index;
                        
                        img.onload = () => {
                            overlayImageContainer.appendChild(img);
                            overlayImageContainer.style.display = 'block';
                            console.log(`야구 활성화된 오버레이 이미지 ${index + 1} 로드됨:`, image.file_path);
                        };
                        
                        img.onerror = (error) => {
                            console.error(`야구 활성화된 오버레이 이미지 ${index + 1} 로드 실패:`, error);
                        };
                    });
                } else {
                    overlayImageContainer.style.display = 'none';
                    console.log('야구 활성화된 오버레이 이미지가 없습니다.');
                }
        } catch (error) {
            console.error('야구 오버레이 이미지 로드 오류:', error);
            document.getElementById('overlayImage').style.display = 'none';
        }
    }

        // 초기 팀 색상 설정
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // 디자인 설정 로드 및 적용
                await loadDesignSettings();
                
                // 오버레이 이미지 로드
                await loadOverlayImage();
                
                // 팀 로고 정보 가져오기 (축구와 동일한 방식)
                const response = await fetch(`/api/matches/${matchId}/team-logos`);
                if (!response.ok) {
                    throw new Error(`팀 로고 정보 로드 실패: ${response.status}`);
                }
                const result = await response.json();
                console.log('팀 로고 정보 로드 성공:', result);
                
                // 홈팀 로고 설정
                const homeTeamName = '<%= match.home_team %>';
                if (result.success && result.teamLogos) {
                    const homeTeamInfo = result.teamLogos.find(team => team.team_type === 'home');
                    if (homeTeamInfo && homeTeamInfo.logo_path) {
                        const homeLogoContainer = document.querySelector('.team-info.home-team .team-logo-container');
                        if (homeLogoContainer) {
                            homeLogoContainer.style.backgroundColor = homeTeamInfo.logo_bg_color || '#ffffff';
                            homeLogoContainer.innerHTML = `
                                <img src="${homeTeamInfo.logo_path}" alt="${homeTeamName} 로고" style="width: 100%; height: 100%; object-fit: contain;">
                            `;
                        }
                    }
                }
                
                // 원정팀 로고 설정
                const awayTeamName = '<%= match.away_team %>';
                if (result.success && result.teamLogos) {
                    const awayTeamInfo = result.teamLogos.find(team => team.team_type === 'away');
                    if (awayTeamInfo && awayTeamInfo.logo_path) {
                        const awayLogoContainer = document.querySelector('.team-info.away-team .team-logo-container');
                        if (awayLogoContainer) {
                            awayLogoContainer.style.backgroundColor = awayTeamInfo.logo_bg_color || '#ffffff';
                            awayLogoContainer.innerHTML = `
                                <img src="${awayTeamInfo.logo_path}" alt="${awayTeamName} 로고" style="width: 100%; height: 100%; object-fit: contain;">
                            `;
                        }
                    }
                }

                // 팀 컬러 정보 로드 및 적용 (DB에서 직접 가져오기)
                const homeTeamSection = document.getElementById('home-team-section');
                const awayTeamSection = document.getElementById('away-team-section');
                
                if (result.success && result.teamLogos) {
                    // 홈팀 컬러 적용
                    const homeTeamInfo = result.teamLogos.find(team => team.team_type === 'home');
                    if (homeTeamInfo && homeTeamInfo.team_color && homeTeamSection) {
                        homeTeamSection.style.backgroundColor = homeTeamInfo.team_color;
                        console.log(`🔧 홈팀 컬러 적용 (초기 로드): ${homeTeamName} -> ${homeTeamInfo.team_color}`);
                    }
                    
                    // 원정팀 컬러 적용
                    const awayTeamInfo = result.teamLogos.find(team => team.team_type === 'away');
                    if (awayTeamInfo && awayTeamInfo.team_color && awayTeamSection) {
                        awayTeamSection.style.backgroundColor = awayTeamInfo.team_color;
                        console.log(`🔧 원정팀 컬러 적용 (초기 로드): ${awayTeamName} -> ${awayTeamInfo.team_color}`);
                    }
                    
                    // 팀 컬러 적용 후 패널 타이틀 초기화
                    setTimeout(() => {
                        const inningType = document.querySelector('.inning-indicator')?.classList.contains('bottom') ? 'bottom' : 'top';
                        updatePanelTitles(inningType);
                        console.log('🔧 초기 로드 후 패널 타이틀 업데이트 완료');
                    }, 100);
                } else {
                    // 팀 로고 정보가 없는 경우에도 패널 타이틀 초기화
                    const inningType = document.querySelector('.inning-indicator')?.classList.contains('bottom') ? 'bottom' : 'top';
                    updatePanelTitles(inningType);
                }
                
            } catch (error) {
                console.error('팀 로고 정보 로드 중 오류 발생:', error);
            }
        });


        // 색상을 투명도가 있는 색상으로 변환하는 헬퍼 함수
        function convertToTransparentColor(color, alpha) {
            // RGB 또는 RGBA 형식인 경우
            if (color.startsWith('rgb')) {
                const rgbValues = color.match(/\d+/g);
                if (rgbValues && rgbValues.length >= 3) {
                    return `rgba(${rgbValues[0]}, ${rgbValues[1]}, ${rgbValues[2]}, ${alpha})`;
                }
            }
            
            // HEX 형식인 경우
            if (color.startsWith('#')) {
                const r = parseInt(color.substr(1, 2), 16);
                const g = parseInt(color.substr(3, 2), 16);
                const b = parseInt(color.substr(5, 2), 16);
                return `rgba(${r}, ${g}, ${b}, ${alpha})`;
            }
            
            // 기본값으로 검은색 반투명 배경 반환
            return `rgba(0, 0, 0, ${alpha})`;
        }

        // 팀명 길이에 따른 폰트 크기 조절
        function adjustTeamNameSize() {
            try {
                const homeTeamHeader = document.querySelector('.team-section .team-info:first-child .team-header');
                const awayTeamHeader = document.querySelector('.team-section .team-info:last-child .team-header');
                
                if (!homeTeamHeader || !awayTeamHeader) {
                    console.error('팀 헤더 요소를 찾을 수 없음');
                    return;
                }
                
                function adjustSize(element) {
                    const text = element.textContent;
                    console.log('팀 이름 크기 조절:', {
                        team: element.closest('.team-info').classList.contains('home-team') ? '홈팀' : '원정팀',
                        text,
                        length: text.length
                    });
                    
                    // 기존 클래스 제거
                    element.classList.remove('long', 'very-long');
                    
                    // 텍스트 길이에 따라 클래스 추가
                    if (text.length > 10) {
                        element.classList.add('very-long');
                        console.log('매우 긴 텍스트 적용');
                    } else if (text.length > 8) {
                        element.classList.add('long');
                        console.log('긴 텍스트 적용');
                    }
                }
                
                adjustSize(homeTeamHeader);
                adjustSize(awayTeamHeader);
                
                console.log('팀 이름 크기 조절 완료');
            } catch (error) {
                console.error('팀 이름 크기 조절 중 오류 발생:', error);
            }
        }
        
        // 팀명 업데이트 시 크기 조절
        socket.on('teamHeaderChanged', function(data) {
            if (data.matchId === matchId) {
                const homeTeamHeader = document.querySelector('.team-section .team-info:first-child .team-header');
                const awayTeamHeader = document.querySelector('.team-section .team-info:last-child .team-header');
                
                if (homeTeamHeader) homeTeamHeader.textContent = data.homeHeader;
                if (awayTeamHeader) awayTeamHeader.textContent = data.awayHeader;
                
                adjustTeamNameSize();
            }
        });
        

        // 팀 로고 삭제 이벤트 처리
        socket.on('teamLogoRemoved', function(data) {
            if (data.matchId === matchId) {
                const teamType = data.teamType || data.team;
                
                console.log('팀 로고 삭제 이벤트 수신:', {
                    teamType,
                    matchId: data.matchId
                });
                
                const logoContainer = document.querySelector(`.team-info.${teamType}-team .team-logo-container`);
                if (logoContainer) {
                    logoContainer.innerHTML = `<div class="team-logo-placeholder"></div>`;
                    console.log(`${teamType}팀 로고 삭제 완료`);
                } else {
                    console.error(`${teamType}팀 로고 컨테이너를 찾을 수 없음`);
                }
            }
        });
        
        // 팀 색상 업데이트 이벤트 처리
        socket.on('teamColorUpdate', function(data) {
            if (data.matchId === matchId) {
                const teamType = data.teamType;
                const teamColor = data.teamColor;
                
                console.log('팀 색상 업데이트 이벤트 수신:', {
                    teamType,
                    teamColor,
                    matchId: data.matchId
                });
                
                const teamSection = document.getElementById(`${teamType}-team-section`);
                if (teamSection) {
                    teamSection.style.backgroundColor = teamColor;
                    console.log(`${teamType}팀 섹션 색상 업데이트:`, {
                        section: teamSection,
                        color: teamColor,
                        appliedColor: teamSection.style.backgroundColor
                    });
                    
                    // 타자/투수 패널의 색상도 업데이트
                    const inningType = document.querySelector('.inning-indicator').classList.contains('bottom') ? 'bottom' : 'top';
                    updatePanelTitles(inningType);
                } else {
                    console.error(`${teamType}팀 섹션을 찾을 수 없음`);
                }
            }
        });

        // 이닝 타입에 따라 패널 타이틀 변경 함수
        function updatePanelTitles(inningType) {
            try {
                const homeTeamName = document.querySelector('.team-info.home-team .team-header')?.textContent || 'HOME';
                const awayTeamName = document.querySelector('.team-info.away-team .team-header')?.textContent || 'AWAY';
                const batterPanel = document.querySelector('.batter-info .panel-title');
                const pitcherPanel = document.querySelector('.pitcher-info .panel-title');
                
                if (!batterPanel || !pitcherPanel) {
                    console.error('패널 타이틀 요소를 찾을 수 없음');
                    return;
                }
                
                // 팀 색상 가져오기
                const homeTeamSection = document.getElementById('home-team-section');
                const awayTeamSection = document.getElementById('away-team-section');
                
                if (!homeTeamSection || !awayTeamSection) {
                    console.error('팀 섹션 요소를 찾을 수 없음');
                    return;
                }
                
                // 팀 컬러 가져오기 (style에서 가져오되, 없으면 computed style에서 가져오기)
                const homeTeamColor = homeTeamSection.style.backgroundColor || 
                                     window.getComputedStyle(homeTeamSection).backgroundColor || 
                                     null;
                const awayTeamColor = awayTeamSection.style.backgroundColor || 
                                     window.getComputedStyle(awayTeamSection).backgroundColor || 
                                     null;
                
                console.log('패널 타이틀 업데이트:', {
                    inningType,
                    homeTeamName,
                    awayTeamName,
                    homeTeamColor,
                    awayTeamColor
                });
                
                if (inningType === 'top') {
                    // 초(top) 이닝: 홈팀 타자, 어웨이팀 투수
                    if (homeTeamColor) batterPanel.style.backgroundColor = homeTeamColor;
                    if (awayTeamColor) pitcherPanel.style.backgroundColor = awayTeamColor;
                    
                    // 패널 제목을 팀명으로 변경
                    batterPanel.textContent = homeTeamName;  // 홈팀 타자
                    pitcherPanel.textContent = awayTeamName; // 어웨이팀 투수
                    
                    console.log('초 이닝: 홈팀 타자, 어웨이팀 투수');
                } else {
                    // 말(bottom) 이닝: 어웨이팀 타자, 홈팀 투수
                    if (awayTeamColor) batterPanel.style.backgroundColor = awayTeamColor;
                    if (homeTeamColor) pitcherPanel.style.backgroundColor = homeTeamColor;
                    
                    // 패널 제목을 팀명으로 변경
                    batterPanel.textContent = awayTeamName;  // 어웨이팀 타자
                    pitcherPanel.textContent = homeTeamName; // 홈팀 투수
                    
                    console.log('말 이닝: 어웨이팀 타자, 홈팀 투수');
                }
            } catch (error) {
                console.error('패널 타이틀 업데이트 중 오류 발생:', error);
            }
        }

        // 팀 이름 업데이트 이벤트
        socket.on('teamNameUpdated', function(data) {
            console.log('팀명 업데이트 이벤트 수신 (첫 번째 리스너):', data);
            
            if (data.matchId === matchId) {
                const team = data.team;
                const teamName = data.teamName;
                
                // 팀 헤더 업데이트
                const teamHeader = document.querySelector(`.team-info.${team}-team .team-header`);
                if (teamHeader) {
                    teamHeader.textContent = teamName;
                }
                
                // 이닝 테이블의 팀명 업데이트
                const teamTableRows = document.querySelectorAll('.innings-table tbody tr');
                if (teamTableRows.length >= 2) {
                    if (team === 'home') {
                        // 홈팀은 첫 번째 행
                        const homeTeamName = teamTableRows[0].querySelector('.team-name');
                        if (homeTeamName) {
                            homeTeamName.textContent = teamName;
                        }
                    } else if (team === 'away') {
                        // 원정팀은 두 번째 행
                        const awayTeamName = teamTableRows[1].querySelector('.team-name');
                        if (awayTeamName) {
                            awayTeamName.textContent = teamName;
                        }
                    }
                }
                
                // 팀명 요소들 업데이트
                const teamNameElements = document.querySelectorAll(`.team-info.${team}-team .team-name`);
                teamNameElements.forEach(element => {
                    element.textContent = teamName;
                });
                
                // 팀 이름 크기 조절
                adjustTeamNameSize();
                
                // 타자/투수 패널의 제목도 업데이트
                updatePanelTitles(document.querySelector('.inning-indicator').classList.contains('bottom') ? 'bottom' : 'top');
                
                console.log(`${team}팀명 업데이트 완료: ${teamName}`);
            }
        });

        // 팀 색상 업데이트 이벤트 처리
        socket.on('teamColorUpdated', function(data) {
            console.log('팀 색상 업데이트 이벤트 수신:', data);
            
            if (data.matchId === matchId) {
                const teamType = data.teamType;
                const teamColor = data.teamColor;
                const headerText = data.headerText;
                
                // 팀 색상 업데이트
                const teamElements = document.querySelectorAll(`.team-info.${teamType}-team`);
                teamElements.forEach(element => {
                    element.style.backgroundColor = teamColor;
                });
                
                // 팀 헤더 텍스트 업데이트 (있는 경우)
                if (headerText) {
                    const headerElements = document.querySelectorAll(`.team-info.${teamType}-team .team-header`);
                    headerElements.forEach(element => {
                        element.textContent = headerText;
                    });
                }
                
                // 팀 섹션 색상 업데이트
                const teamSection = document.getElementById(`${teamType}-team-section`);
                if (teamSection) {
                    teamSection.style.backgroundColor = teamColor;
                    console.log(`${teamType}팀 섹션 색상 업데이트:`, {
                        section: teamSection,
                        color: teamColor,
                        teamType: teamType
                    });
                    
                    // 타자/투수 패널의 색상도 업데이트
                    const inningType = document.querySelector('.inning-indicator')?.classList.contains('bottom') ? 'bottom' : 'top';
                    updatePanelTitles(inningType);
                    console.log('🔧 타자/투수 패널 팀컬러 업데이트 완료 (teamColorUpdated 이벤트)');
                } else {
                    console.error(`${teamType}팀 섹션을 찾을 수 없음`);
                }
                
                console.log(`${teamType}팀 색상 업데이트 완료: ${teamColor}`);
            }
        });

        // 팀로고 배경색 업데이트 이벤트 처리 (팀컬러와 동일한 방식)
        socket.on('teamLogoBgUpdated', function(data) {
            console.log('팀로고 배경색 업데이트 이벤트 수신:', data);
            
            if (data.matchId === matchId) {
                const teamType = data.teamType;
                const logoBgColor = data.logoBgColor;
                
                // 팀로고 배경색 업데이트
                const logoContainers = document.querySelectorAll(`.team-info.${teamType}-team .team-logo-container`);
                logoContainers.forEach(container => {
                    container.style.backgroundColor = logoBgColor || '#ffffff';
                });
                
                console.log(`${teamType}팀로고 배경색 업데이트 완료: ${logoBgColor}`);
            }
        });


        // 스코어 업데이트 이벤트
        socket.on('scoreUpdated', (data) => {
            console.log('스코어 업데이트:', data);
            
            // 스코어와 기타 정보 업데이트
            document.querySelector('.home-team .team-score').textContent = data.home_score || '0';
            document.querySelector('.away-team .team-score').textContent = data.away_score || '0';
            
            // 베이스 상태 업데이트
            document.querySelector('.base.first').classList.toggle('active', data.match_data?.first_base);
            document.querySelector('.base.second').classList.toggle('active', data.match_data?.second_base);
            document.querySelector('.base.third').classList.toggle('active', data.match_data?.third_base);
            
            // 볼/스트라이크/아웃 카운트 업데이트
            document.querySelectorAll('.count-dot.ball').forEach((dot, index) => {
                dot.classList.toggle('active', (data.match_data?.balls || 0) >= index + 1);
            });
            document.querySelectorAll('.count-dot.strike').forEach((dot, index) => {
                dot.classList.toggle('active', (data.match_data?.strikes || 0) >= index + 1);
            });
            document.querySelectorAll('.count-dot.out').forEach((dot, index) => {
                dot.classList.toggle('active', (data.match_data?.outs || 0) >= index + 1);
            });
            
            // 이닝 표시 업데이트
            document.querySelector('.current-inning').innerHTML = `
                ${data.match_data?.current_inning || '1'}
                <div class="inning-indicator ${data.match_data?.inning_type === 'bottom' ? 'bottom' : 'top'}"></div>
            `;
            
            // 이닝 스코어 업데이트
            if (data.match_data?.innings) {
                for (let i = 1; i <= 9; i++) {
                    document.getElementById(`teamA-inning-${i}`).textContent = data.match_data.innings[`home_${i}`] || '0';
                    document.getElementById(`teamB-inning-${i}`).textContent = data.match_data.innings[`away_${i}`] || '0';
                }
            }
            
            // 이닝별 점수 합계 계산
            let homeTotalScore = 0;
            let awayTotalScore = 0;
            
            if (data.match_data?.innings) {
                for (let i = 1; i <= 9; i++) {
                    homeTotalScore += parseInt(data.match_data.innings[`home_${i}`] || '0');
                    awayTotalScore += parseInt(data.match_data.innings[`away_${i}`] || '0');
                }
            } else {
                homeTotalScore = data.home_score || 0;
                awayTotalScore = data.away_score || 0;
            }
            
            // 히트와 에러 업데이트 (합계 점수 사용)
            document.querySelector('.innings-table tbody tr:first-child td.total:nth-child(11)').textContent = homeTotalScore;
            document.querySelector('.innings-table tbody tr:first-child td.total:nth-child(12)').textContent = data.match_data?.home_hits || '0';
            document.querySelector('.innings-table tbody tr:first-child td.total:nth-child(13)').textContent = data.match_data?.home_errors || '0';
            document.querySelector('.innings-table tbody tr:last-child td.total:nth-child(11)').textContent = awayTotalScore;
            document.querySelector('.innings-table tbody tr:last-child td.total:nth-child(12)').textContent = data.match_data?.away_hits || '0';
            document.querySelector('.innings-table tbody tr:last-child td.total:nth-child(13)').textContent = data.match_data?.away_errors || '0';
            
            // 이닝 타입에 따라 패널 타이틀 업데이트
            updatePanelTitles(data.match_data?.inning_type);
        });

        // 야구 이닝 스코어 업데이트 이벤트 처리
        socket.on('baseball_inning_score_updated', (data) => {
            console.log('=== 야구 이닝 스코어 업데이트 수신 (오버레이) ===');
            console.log('수신된 데이터:', data);
            console.log('현재 matchId:', matchId);
            console.log('데이터 matchId:', data.matchId);
            
            if (data.matchId === matchId) {
                const { team, inning, score, innings, home_score, away_score } = data;
                
                // 이닝 스코어 테이블 업데이트
                const teamElementId = team === 'home' ? `teamA-inning-${inning}` : `teamB-inning-${inning}`;
                const inningElement = document.getElementById(teamElementId);
                
                if (inningElement) {
                    inningElement.textContent = score;
                    console.log(`이닝 스코어 업데이트: ${team}팀 ${inning}회 = ${score}`);
                }
                
                // 전체 이닝 스코어 업데이트 (모든 이닝)
                if (innings) {
                    for (let i = 1; i <= 9; i++) {
                        const homeInningElement = document.getElementById(`teamA-inning-${i}`);
                        const awayInningElement = document.getElementById(`teamB-inning-${i}`);
                        
                        if (homeInningElement && innings[`home_${i}`] !== undefined) {
                            homeInningElement.textContent = innings[`home_${i}`] || '0';
                        }
                        if (awayInningElement && innings[`away_${i}`] !== undefined) {
                            awayInningElement.textContent = innings[`away_${i}`] || '0';
                        }
                    }
                }
                
                // 서버에서 계산된 총 점수 사용 (undefined일 때는 기존 값 유지)
                const homeTotal = home_score !== undefined ? home_score : (document.querySelector('.home-team .team-score')?.textContent || '0');
                const awayTotal = away_score !== undefined ? away_score : (document.querySelector('.away-team .team-score')?.textContent || '0');
                
                // 메인 스코어보드 업데이트
                const homeScoreElement = document.querySelector('.home-team .team-score');
                const awayScoreElement = document.querySelector('.away-team .team-score');
                
                if (homeScoreElement) homeScoreElement.textContent = homeTotal;
                if (awayScoreElement) awayScoreElement.textContent = awayTotal;
                
                // 이닝 스코어보드의 총 점수도 업데이트
                const homeTotalElement = document.querySelector('.innings-table tbody tr:first-child td.total:nth-child(11)');
                const awayTotalElement = document.querySelector('.innings-table tbody tr:last-child td.total:nth-child(11)');
                
                if (homeTotalElement) homeTotalElement.textContent = homeTotal;
                if (awayTotalElement) awayTotalElement.textContent = awayTotal;
                
                console.log(`총 점수 업데이트: 홈팀 ${homeTotal}, 원정팀 ${awayTotal}`);
                console.log('=== 야구 이닝 스코어 업데이트 처리 완료 (오버레이) ===');
            } else {
                console.log('매치 ID가 일치하지 않음 - 이벤트 무시');
            }
        });

        // 야구 오버레이 표시/숨김 업데이트 이벤트 처리
        socket.on('baseball_overlay_visibility_updated', (data) => {
            console.log('야구 오버레이 표시 상태 업데이트 수신:', data);
            
            if (data.matchId === matchId) {
                const { overlayType, isVisible, overlay_visibility } = data;
                
                // 각 오버레이 요소의 표시/숨김 처리
                if (overlayType === 'batter') {
                    const batterInfo = document.querySelector('.batter-info');
                    if (batterInfo) {
                        batterInfo.style.display = isVisible ? 'block' : 'none';
                        console.log(`타자 정보 오버레이 ${isVisible ? '표시' : '숨김'}`);
                    }
                } else if (overlayType === 'pitcher') {
                    const pitcherInfo = document.querySelector('.pitcher-info');
                    if (pitcherInfo) {
                        pitcherInfo.style.display = isVisible ? 'block' : 'none';
                        console.log(`투수 정보 오버레이 ${isVisible ? '표시' : '숨김'}`);
                    }
                } else if (overlayType === 'innings') {
                    const inningsScoreboard = document.querySelector('.innings-scoreboard');
                    if (inningsScoreboard) {
                        inningsScoreboard.style.display = isVisible ? 'block' : 'none';
                        console.log(`이닝 스코어보드 오버레이 ${isVisible ? '표시' : '숨김'}`);
                    }
                }
                
                // 전체 오버레이 표시 상태 저장
                if (overlay_visibility) {
                    window.overlayVisibility = overlay_visibility;
                }
            }
        });

        // 야구 전용 팀 로고/컬러/배경색 실시간 반영

        // 팀 위치 변경 이벤트 처리
        socket.on('teamsSwapped', async function(data) {
            console.log('팀 위치 변경 이벤트 수신:', data);
            
            if (data.matchId === matchId) {
                // 팀명 업데이트
                const homeTeamElements = document.querySelectorAll('.team-info.home-team .team-header');
                const awayTeamElements = document.querySelectorAll('.team-info.away-team .team-header');
                
                homeTeamElements.forEach(element => {
                    element.textContent = data.home_team;
                });
                awayTeamElements.forEach(element => {
                    element.textContent = data.away_team;
                });
                
                // 점수 업데이트
                const homeScoreElements = document.querySelectorAll('.team-info.home-team .team-score');
                const awayScoreElements = document.querySelectorAll('.team-info.away-team .team-score');
                
                homeScoreElements.forEach(element => {
                    element.textContent = data.home_score;
                });
                awayScoreElements.forEach(element => {
                    element.textContent = data.away_score;
                });
                
                // 이닝 테이블의 팀명도 업데이트
                const homeTableNameElements = document.querySelectorAll('.innings-table tbody tr:first-child .team-name');
                const awayTableNameElements = document.querySelectorAll('.innings-table tbody tr:last-child .team-name');
                
                homeTableNameElements.forEach(element => {
                    element.textContent = data.home_team;
                });
                awayTableNameElements.forEach(element => {
                    element.textContent = data.away_team;
                });
                
                // 팀 로고 업데이트 (축구와 동일한 방식)
                try {
                    const response = await fetch(`/api/matches/${matchId}/team-logos`);
                    if (response.ok) {
                        const result = await response.json();
                        
                        // 홈팀 로고 업데이트 (축구와 동일한 방식)
                        if (result.success && result.teamLogos) {
                            const homeTeamInfo = result.teamLogos.find(team => team.team_type === 'home');
                            const homeLogoContainers = document.querySelectorAll('.team-info.home-team .team-logo-container');
                            homeLogoContainers.forEach(container => {
                                if (homeTeamInfo && homeTeamInfo.logo_path) {
                                    container.style.backgroundColor = homeTeamInfo.logo_bg_color || '#ffffff';
                                    container.innerHTML = `
                                        <img src="${homeTeamInfo.logo_path}" alt="${data.home_team} 로고" class="team-logo">
                                    `;
                                } else {
                                    container.style.backgroundColor = '#f8f9fa';
                                    container.innerHTML = '<span style="font-size: 0.8rem; color: #6c757d;">로고</span>';
                                }
                            });
                            
                            // 원정팀 로고 업데이트
                            const awayTeamInfo = result.teamLogos.find(team => team.team_type === 'away');
                            const awayLogoContainers = document.querySelectorAll('.team-info.away-team .team-logo-container');
                            awayLogoContainers.forEach(container => {
                                if (awayTeamInfo && awayTeamInfo.logo_path) {
                                    container.style.backgroundColor = awayTeamInfo.logo_bg_color || '#ffffff';
                                    container.innerHTML = `
                                        <img src="${awayTeamInfo.logo_path}" alt="${data.away_team} 로고" class="team-logo">
                                    `;
                                } else {
                                    container.style.backgroundColor = '#f8f9fa';
                                    container.innerHTML = '<span style="font-size: 0.8rem; color: #6c757d;">로고</span>';
                                }
                            });
                        }
                    }
                } catch (error) {
                    console.error('팀 로고 업데이트 중 오류 발생:', error);
                }
                
                console.log('팀 위치 변경 완료');
            }
        });

        // 스포츠 오버레이 이미지 변경 이벤트 처리 (야구용)
        socket.on('sport_overlay_image_updated', function(data) {
            console.log('야구 스포츠 오버레이 이미지 업데이트:', data);
            
            if (data.action === 'uploaded') {
                // 새 이미지가 업로드된 경우 - 활성화된 이미지들 다시 로드
                loadOverlayImage();
            } else if (data.action === 'deleted') {
                // 이미지가 삭제된 경우 - 활성화된 이미지들 다시 로드
                loadOverlayImage();
            } else if (data.action === 'activated') {
                // 이미지가 활성화된 경우 - 활성화된 이미지들 다시 로드
                loadOverlayImage();
            } else if (data.action === 'status_changed') {
                // 이미지 상태가 변경된 경우 - 활성화된 이미지들 다시 로드
                console.log('야구 이미지 상태 변경됨:', data);
                loadOverlayImage();
            }
        });

        // 오버레이 이미지 상태 변경 실시간 이벤트 처리 (동적 처리)
        socket.on('overlay_image_status_changed', function(data) {
            console.log('🔧 야구 오버레이 이미지 상태 변경 실시간 이벤트:', data);
            console.log('🔧 현재 window.matchData:', window.matchData);
            console.log('🔧 현재 경기 sport_type:', window.matchData?.sport_type);
            console.log('🔧 이벤트 sportCode:', data.sportCode);
            
            // 현재 경기의 스포츠 타입과 동적 비교 (window.matchData 사용)
            if (data.sportCode === window.matchData?.sport_type) {
                console.log('🔧 야구 스포츠 타입 일치, 이미지 처리 시작');
                
                if (data.isActive && data.imageData) {
                    // 이미지 활성화 - 해당 이미지만 추가 표시
                    console.log('🔧 야구 오버레이 이미지 활성화:', data.imageData);
                    addOverlayImage(data.imageData);
                } else if (!data.isActive && data.imageData) {
                    // 이미지 비활성화 - 해당 이미지만 제거
                    console.log('🔧 야구 오버레이 이미지 비활성화:', data.imageData);
                    removeOverlayImage(data.imageData.id);
                }
            } else {
                console.log('🔧 야구 스포츠 타입 불일치, Room 재참여 시도');
                // 스포츠 타입이 일치하지 않으면 Room 재참여 시도
                if (window.matchData?.sport_type) {
                    console.log('🔧 야구 Room 재참여 요청:', window.matchData.sport_type);
                    socket.emit('join_sport_room', window.matchData.sport_type);
                }
            }
        });

        // 오버레이 페이지 새로고침 이벤트 처리
        socket.on('overlay_page_refresh', function(data) {
            console.log('🔧 야구 오버레이 페이지 새로고침 신호 수신:', data);
            console.log('🔧 현재 window.matchData:', window.matchData);
            console.log('🔧 현재 경기 sport_type:', window.matchData?.sport_type);
            console.log('🔧 이벤트 sportCode:', data.sportCode);
            
            // 현재 경기의 스포츠 타입과 동적 비교
            if (data.sportCode === window.matchData?.sport_type) {
                console.log('🔧 야구 오버레이 페이지 새로고침 실행:', data.reason);
                // 페이지 새로고침
                location.reload();
            } else {
                console.log('🔧 야구 스포츠 타입 불일치로 새로고침 건너뜀');
            }
        });

        // dataChanged 이벤트 처리 (실시간 업데이트)
        socket.on('dataChanged', async function(data) {
            console.log('🔧 dataChanged 이벤트 수신 (야구):', data);
            console.log('🔧 현재 경기 ID:', matchId);
            console.log('🔧 이벤트 경기 ID:', data.matchId);
            console.log('🔧 이벤트 타입:', data.type);
            console.log('🔧 팀 타입:', data.teamType);

            if (data.matchId === matchId) {
                console.log('🔧 동일 경기 dataChanged 이벤트 - 데이터 재로드 시작');
                setTimeout(async () => {
                    try {
                        console.log('🔧 500ms 지연 후 데이터 재로드 실행');
                        await loadMatchData();
                        
                        // 팀로고 정보도 함께 로드
                        if (data.type === 'teamLogo' || data.type === 'teamName' || data.type === 'teamColor') {
                            console.log('🔧 팀로고 정보 재로드 시작');
                            const response = await fetch(`/api/matches/${matchId}/team-logos`);
                            if (response.ok) {
                                const result = await response.json();
                                console.log('🔧 팀로고 정보 응답:', result);
                                
                                // 홈팀 로고 업데이트
                                if (result.teamLogos && result.teamLogos.length > 0) {
                                    const homeTeamInfo = result.teamLogos.find(team => team.team_type === 'home');
                                    const awayTeamInfo = result.teamLogos.find(team => team.team_type === 'away');
                                    
                                    console.log('🔧 홈팀 정보:', homeTeamInfo);
                                    console.log('🔧 어웨이팀 정보:', awayTeamInfo);
                                    
                                    if (homeTeamInfo) {
                                        const homeLogoContainers = document.querySelectorAll('.team-info.home-team .team-logo-container');
                                        console.log('🔧 홈팀 로고 컨테이너 개수:', homeLogoContainers.length);
                                        homeLogoContainers.forEach(container => {
                                            if (homeTeamInfo.logo_path) {
                                                container.innerHTML = `
                                                    <img src="${homeTeamInfo.logo_path}" alt="홈팀 로고" class="team-logo">
                                                `;
                                                container.style.backgroundColor = homeTeamInfo.logo_bg_color || '#ffffff';
                                                console.log('🔧 홈팀 로고 업데이트 완료:', homeTeamInfo.logo_path);
                                            } else {
                                                container.innerHTML = `<div class="team-logo-placeholder"></div>`;
                                                console.log('🔧 홈팀 로고 없음 - 플레이스홀더 표시');
                                            }
                                        });
                                        
                                        // 홈팀 섹션 컬러 업데이트
                                        if (homeTeamInfo.team_color) {
                                            const homeTeamSection = document.getElementById('home-team-section');
                                            if (homeTeamSection) {
                                                homeTeamSection.style.backgroundColor = homeTeamInfo.team_color;
                                                console.log('🔧 홈팀 섹션 컬러 업데이트:', homeTeamInfo.team_color);
                                            }
                                        }
                                    }
                                    
                                    if (awayTeamInfo) {
                                        const awayLogoContainers = document.querySelectorAll('.team-info.away-team .team-logo-container');
                                        console.log('🔧 어웨이팀 로고 컨테이너 개수:', awayLogoContainers.length);
                                        awayLogoContainers.forEach(container => {
                                            if (awayTeamInfo.logo_path) {
                                                container.innerHTML = `
                                                    <img src="${awayTeamInfo.logo_path}" alt="원정팀 로고" class="team-logo">
                                                `;
                                                container.style.backgroundColor = awayTeamInfo.logo_bg_color || '#ffffff';
                                                console.log('🔧 어웨이팀 로고 업데이트 완료:', awayTeamInfo.logo_path);
                                            } else {
                                                container.innerHTML = `<div class="team-logo-placeholder"></div>`;
                                                console.log('🔧 어웨이팀 로고 없음 - 플레이스홀더 표시');
                                            }
                                        });
                                        
                                        // 어웨이팀 섹션 컬러 업데이트
                                        if (awayTeamInfo.team_color) {
                                            const awayTeamSection = document.getElementById('away-team-section');
                                            if (awayTeamSection) {
                                                awayTeamSection.style.backgroundColor = awayTeamInfo.team_color;
                                                console.log('🔧 어웨이팀 섹션 컬러 업데이트:', awayTeamInfo.team_color);
                                            }
                                        }
                                    }
                                }
                                
                                // 타자/투수 패널의 팀컬러도 업데이트
                                const inningType = document.querySelector('.inning-indicator')?.classList.contains('bottom') ? 'bottom' : 'top';
                                updatePanelTitles(inningType);
                                console.log('🔧 타자/투수 패널 팀컬러 업데이트 완료');
                                
                                console.log('🔧 팀로고 정보 재로드 완료');
                            } else {
                                console.error('🔧 팀로고 정보 로드 실패:', response.status);
                            }
                        }
                        
                        console.log('🔧 데이터 재로드 완료');
                    } catch (error) {
                        console.error('🔧 데이터 재로드 오류:', error);
                    }
                }, 500);
            } else {
                console.log('🔧 다른 경기의 dataChanged 이벤트로 무시');
            }
        });

        // 팀로고 업데이트 이벤트 처리 (통합된 방식)
        socket.on('teamLogoUpdated', function(data) {
            if (data.matchId !== matchId) return;
            
            console.log('팀로고 업데이트 수신:', data);
            
            const teamType = data.teamType;
            const logoPath = data.logoPath;
            const logoBgColor = data.logoBgColor || '#ffffff';
            
            // 해당 팀의 로고 컨테이너 찾기
            const logoContainer = document.querySelector(`.team-info.${teamType}-team .team-logo-container`);
            if (logoContainer) {
                // 배경색 업데이트
                logoContainer.style.backgroundColor = logoBgColor;
                
                // 로고 이미지 업데이트
                if (logoPath) {
                    logoContainer.innerHTML = `
                        <img src="${logoPath}" alt="${teamType === 'home' ? '홈' : '원정'}팀 로고" 
                             style="width: 100%; height: 100%; object-fit: contain;">
                    `;
                } else {
                    logoContainer.innerHTML = `<div class="team-logo-placeholder"></div>`;
                }
                
                console.log(`${teamType}팀 로고 업데이트 완료: ${logoPath}, 배경색: ${logoBgColor}`);
            } else {
                console.error(`${teamType}팀 로고 컨테이너를 찾을 수 없음`);
            }
        });

        // 리스트 기능 관련 변수
        let currentMatchIndex = 0;
        let totalMatches = 0;
        let listId = null;
        
        <% if (typeof listId !== 'undefined' && listId) { %>
        currentMatchIndex = <%- currentMatchIndex || 0 %>;
        totalMatches = <%- totalMatches || 0 %>;
        listId = '<%- listId %>';
        
        // 리스트 정보 표시
        function showListInfo() {
            const listInfo = document.getElementById('listInfo');
            const listName = document.getElementById('listName');
            const matchCounter = document.getElementById('matchCounter');
            
            if (listInfo && listName && matchCounter) {
                listName.textContent = '리스트: <%= typeof listName !== "undefined" ? listName : "경기 리스트" %>';
                matchCounter.textContent = `경기 ${currentMatchIndex + 1} / ${totalMatches}`;
                listInfo.classList.add('show');
                
                // 3초 후 자동 숨김
                setTimeout(() => {
                    listInfo.classList.remove('show');
                }, 3000);
            }
        }
        
        // 다음 경기로 이동
        async function nextMatch() {
            if (currentMatchIndex < totalMatches - 1) {
                currentMatchIndex++;
                await loadCurrentMatch();
            }
        }
        
        // 이전 경기로 이동
        async function prevMatch() {
            if (currentMatchIndex > 0) {
                currentMatchIndex--;
                await loadCurrentMatch();
            }
        }
        
        // 현재 경기 로드
        async function loadCurrentMatch() {
            try {
                const response = await fetch(`/api/list/${listId}/current-match?index=${currentMatchIndex}`);
                if (!response.ok) throw new Error('경기 정보 로드 실패');
                
                const data = await response.json();
                
                // 페이지 새로고침으로 경기 변경
                window.location.href = `/list/${listId}/overlay?index=${currentMatchIndex}`;
            } catch (error) {
                console.error('경기 로드 오류:', error);
            }
        }
        
        // 키보드 이벤트 리스너 추가
        document.addEventListener('keydown', function(e) {
            switch(e.key) {
                case 'ArrowLeft':
                    prevMatch();
                    break;
                case 'ArrowRight':
                    nextMatch();
                    break;
                case 'i':
                case 'I':
                    showListInfo();
                    break;
            }
        });
        
        // 페이지 로드 시 리스트 정보 표시
        window.addEventListener('load', function() {
            setTimeout(showListInfo, 1000);
        });
        <% } %>
        
        // 야구는 타이머가 필요없으므로 하이브리드 타이머 시스템을 사용하지 않습니다.
        
    </script>
</body>
</html> 